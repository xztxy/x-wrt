From e86b89d026fa963ff6c789747b9b373884956157 Mon Sep 17 00:00:00 2001
From: Evelyn Tsai <evelyn.tsai@mediatek.com>
Date: Fri, 1 Dec 2023 08:48:35 +0800
Subject: [PATCH] mac80211: mtk: ACS channel time is reset by ch_restore

Issue:
There's a chance that the channel time for duty channel is zero in ACS
scan.

Root cause:
The chan_stat may be reset when restore to duty channel.
Mac80211 will notify to hostapd when scan done and then restore to duty
channel.
And mt76 will clear scan flag after restore done.
If hostapd get the chan_stat before channel_restore, will get the
correct channel time;
If hostapd get the chan_stat after channel_restore, will get zero
channel time;

Solution:
When channel switch, will check the mac80211 scan state but not the mt76 scan flag.
Mac80211 scan state will be set in scanning, and will be reset after
scan done and before restore to duty channel.

Signed-off-by: fancy.liu <fancy.liu@mediatek.com>
---
 include/net/mac80211.h | 7 +++++++
 net/mac80211/util.c    | 8 ++++++++
 2 files changed, 15 insertions(+)

diff --git a/include/net/mac80211.h b/include/net/mac80211.h
index 2b9c0e7..8a736fa 100644
--- a/include/net/mac80211.h
+++ b/include/net/mac80211.h
@@ -7745,6 +7745,13 @@ int ieee80211_set_active_links(struct ieee80211_vif *vif, u16 active_links);
 void ieee80211_set_active_links_async(struct ieee80211_vif *vif,
 				      u16 active_links);
 
+/**
+ * ieee80211_get_scanning - get scanning bitmask
+ *
+ * @hw: pointer as obtained from ieee80211_alloc_hw()
+ */
+unsigned long ieee80211_get_scanning(struct ieee80211_hw *hw);
+
 /**
  * ieee80211_send_teardown_neg_ttlm - tear down a negotiated TTLM request
  * @vif: the interface on which the tear down request should be sent.
diff --git a/net/mac80211/util.c b/net/mac80211/util.c
index 2b6f529..d46d218 100644
--- a/net/mac80211/util.c
+++ b/net/mac80211/util.c
@@ -4562,3 +4562,11 @@ bool ieee80211_vif_nan_started(struct ieee80211_vif *vif)
 	return vif->type == NL80211_IFTYPE_NAN && sdata->u.nan.started;
 }
 EXPORT_SYMBOL_GPL(ieee80211_vif_nan_started);
+
+unsigned long ieee80211_get_scanning(struct ieee80211_hw *hw)
+{
+	struct ieee80211_local *local = hw_to_local(hw);
+
+	return local->scanning;
+}
+EXPORT_SYMBOL(ieee80211_get_scanning);
-- 
2.17.1

